<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integrid Tax Issue Reporting System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .table-container {
            overflow-x: auto;
            margin-bottom: 20px;
        }
        .table-responsive {
            width: 100%;
            overflow-x: auto;
        }
        .table-responsive table {
            min-width: 800px;
        }
        .select-wrapper select {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            width: 100%;
            padding: 0.75rem 2.5rem 0.75rem 0.75rem;
            border-radius: 0.375rem;
            border: 1px solid #d1d5db;
            outline: none;
            font-size: 1rem;
            color: #4b5563;
            background-color: #fff;
            cursor: pointer;
            transition: border-color 0.15s ease-in-out, shadow-sm 0.15s ease-in-out;
        }

        .select-wrapper select:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
        }

        .select-wrapper::after {
            content: "";
            position: absolute;
            top: 50%;
            right: 1rem;
            transform: translateY(-50%);
            width: 0.625rem;
            height: 0.625rem;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
            background-size: 1rem;
            background-repeat: no-repeat;
            pointer-events: none;
        }

        .select-wrapper select option {
            padding: 0.75rem;
            font-size: 1rem;
            color: #4b5563;
            background-color: #fff;
        }

        .select-wrapper select option:hover,
        .select-wrapper select option:checked {
            background-color: #f0f0f0;
        }
        
        /* Loading spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #3b82f6;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 p-6 rounded-lg">
    <h1 class="text-4xl font-bold text-center text-blue-700 mb-8 border-2 border-blue-400 rounded-md p-4">Integrid Tax Issue Reporting System</h1>

    <div class="bg-white rounded-lg shadow-md p-6 mb-8 border-2 border-gray-300">
        <h2 class="text-xl font-semibold text-gray-800 mb-4 underline">Important Information</h2>
        <ol class="list-decimal list-inside space-y-2">
            <li class="flex items-start">
                <span class="font-semibold mr-1">PLEASE UPLOAD THE QUESTION ATTACHMENT FILE ON THIS DRIVE :</span> 
                    <a href="https://drive.google.com/drive/folders/1TtYH6e1c3nIP-uHX_mPEqcVKIjNr2-iT?usp=drive_link" target="_blank" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-2 rounded focus:outline-none focus:shadow-outline inline-block ml-2 text-sm">
                        Here
                    </a>
                
            </li>
            <li class="flex items-start">
                <span class="font-semibold mr-1">PLEASE UPLOAD THE ANSWER ATTACHMENT FILE ON THIS DRIVE :</span>
                    <a href="https://drive.google.com/drive/folders/1ihFleQ0ONU4S9C-cjmlkJZov1RuvYjvk?usp=drive_link" target="_blank" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-2 rounded focus:outline-none focus:shadow-outline inline-block ml-2 text-sm">
                        Here
                    </a>
                
            </li>
        </ol>
    </div>

    <div class="form-container bg-white rounded-lg shadow-md p-8 mb-6">
        <h2 class="text-xl font-semibold text-gray-800 mb-6">Report an Issue</h2>
        <form id="issueForm" class="space-y-4">
            <div>
                <label for="period" class="block text-gray-700 text-sm font-bold mb-2">Period:</label>
                <select id="period" name="period" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                    <option value="" disabled selected>Select Month</option>
                    <option value="January">January</option>
                    <option value="February">February</option>
                    <option value="March">March</option>
                    <option value="April">April</option>
                    <option value="May">May</option>
                    <option value="June">June</option>
                    <option value="July">July</option>
                    <option value="August">August</option>
                    <option value="September">September</option>
                    <option value="October">October</option>
                    <option value="November">November</option>
                    <option value="December">December</option>
                </select>
            </div>
            <div>
                <label for="company" class="block text-gray-700 text-sm font-bold mb-2">Company:</label>
                <div class="select-wrapper relative">
                    <!-- Searchable Dropdown -->
                    <input type="text" id="companySearch" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline mb-2" placeholder="Search Company..." autocomplete="off" oninput="filterCompanies()">
                    
                    <select id="company" name="company" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        <option value="" disabled selected>Select Company</option>
                        <option value="The Bluejay">The Bluejay</option>
                        <option value="Barong Family">Barong Family</option>
                        <option value="Sababa - Elno Noli Putih">Sababa - Elno Noli Putih</option>
                        <option value="Karisa Lifestyle">Karisa Lifestyle</option>
                        <option value="Indah Nusa Timur">Indah Nusa Timur</option>
                        <option value="INTEGRID">INTEGRID</option>
                        <option value="Gelareh Design">Gelareh Design</option>
                        <option value="Sunkiss Restaurant">Sunkiss Restaurant</option>
                        <option value="Rent Surfboard Bali">Rent Surfboard Bali</option>
                        <option value="Improvea Maju Solusi">Improvea Maju Solusi</option>
                        <option value="Trio Rukun Sejahtera">Trio Rukun Sejahtera</option>
                        <option value="Ola Casa Bali">Ola Casa Bali</option>
                        <option value="Moonkey Group">Moonkey Group</option>
                        <option value="Anugrah Pangan Jaya (CIBO)">Anugrah Pangan Jaya (CIBO)</option>
                        <option value="Liva">Liva</option>
                        <option value="You Spa Bali">You Spa Bali</option>
                        <option value="Pemandangan HIjau Bali">Pemandangan HIjau Bali</option>
                        <option value="Kayu Living Bali">Kayu Living Bali</option>
                        <option value="Serenity Property Bali">Serenity Property Bali</option>
                        <option value="Weddingup Event Organizer">Weddingup Event Organizer</option>
                        <option value="Bienaime Samyn Investment">Bienaime Samyn Investment</option>
                        <option value="Bali Couple Retreats">Bali Couple Retreats</option>
                        <option value="Denpasar Indah Seruni">Denpasar Indah Seruni</option>
                        <option value="Maza Bali Investing">Maza Bali Investing</option>
                        <option value="Martin Family Agency">Martin Family Agency</option>
                        <option value="Masa Depan Utama Lestari">Masa Depan Utama Lestari</option>
                        <option value="Sportva">Sportva</option>
                        <option value="JGM Group Management">JGM Group Management</option>
                        <option value="Naoli Eliam Group">Naoli Eliam Group</option>
                        <option value="Evasion Villa Bali">Evasion Villa Bali</option>
                        <option value="Pauline & Luke Consulting">Pauline & Luke Consulting</option>
                        <option value="Bali Real Estate - Anjuna Bay">Bali Real Estate - Anjuna Bay</option>
                        <option value="HMZ Digital Agency">HMZ Digital Agency</option>
                        <option value="Shade Agency Bali">Shade Agency Bali</option>
                        <option value="Mid Night Sun">Mid Night Sun</option>
                        <option value="Neala Nature Stays">Neala Nature Stays</option>
                        <option value="Deprince Global Services">Deprince Global Services</option>
                        <option value="Lucky Cat Land">Lucky Cat Land</option>
                        <option value="Only Loading Asia">Only Loading Asia</option>
                        <option value="Women Bali Bahagia">Women Bali Bahagia</option>
                        <option value="Sunder Jupiter Bali">Sunder Jupiter Bali</option>
                        <option value="Aanoukis Tropix Retail">Aanoukis Tropix Retail</option>
                        <option value="Bybali Build Consulting">Bybali Build Consulting</option>
                        <option value="Snaaack Padang Bai">Snaaack Padang Bai</option>
                        <option value="The Naluri Bali">The Naluri Bali</option>
                        <option value="Hocus Pocus Prod">Hocus Pocus Prod</option>
                        <option value="Kim Advantage Consulting">Kim Advantage Consulting</option>
                        <option value="Bejoi Design Bali">Bejoi Design Bali</option>
                        <option value="Nyata Consulting Bali">Nyata Consulting Bali</option>
                        <option value="Tran Manh Sung">Tran Manh Sung</option>
                        <option value="The Blackless Lovers">The Blackless Lovers</option>
                        <option value="Maju Operation & Development">Maju Operation & Development</option>
                        <option value="Dragon Indonesia Exotics">Dragon Indonesia Exotics</option>
                        <option value="Elodie Mattei Group">Elodie Mattei Group</option>
                        <option value="Chatelain Advisory Investment">Chatelain Advisory Investment</option>
                        <option value="Cabana Bali Style">Cabana Bali Style</option>
                        <option value="Good Move">Good Move</option>
                        <option value="Slow Nomad Living">Slow Nomad Living</option>
                        <option value="The Agency Bali">The Agency Bali</option>
                        <option value="Esensi Digital Agency">Esensi Digital Agency</option>
                        <option value="LNH Reality and Flavor">LNH Reality and Flavor</option>
                        <option value="MYMS">MYMS</option>
                        <option value="Modern Groove Reverie">Modern Groove Reverie</option>
                        <option value="PT. LUNES SACREES BALI">PT. LUNES SACREES BALI</option>
                        <option value="PT. JOY BIRD INVEST">PT. JOY BIRD INVEST</option>
                        <option value="PT. WEAREBRAND PRODUCTION DIGITAL">PT. WEAREBRAND PRODUCTION DIGITAL</option>
                        <option value="PT. BEBAS EXPERIENCE GROUP">PT. BEBAS EXPERIENCE GROUP</option>
                        <option value="PT. THE SUNRISE PRODUCTION">PT. THE SUNRISE PRODUCTION</option>
                        <option value="THE BACKLESS LOVERS">THE BACKLESS LOVERS</option>
                        <option value="PT THE CENTURY GROUP">PT THE CENTURY GROUP</option>
                        <option value="BALI ISLAND BOUNCE">BALI ISLAND BOUNCE </option>
                        <option value="PT BALI JADAYO IMMO">PT BALI JADAYO IMMO</option>
                        <option value="PT DEL VALLE GURRUTXAGA">PT DEL VALLE GURRUTXAGA</option>
                        <option value="PT THE SURFER GUIDE BALI">PT THE SURFER GUIDE BALI</option>
                        <option value="PT CALA BALI INVESTMENT">PT CALA BALI INVESTMENT</option>
                        <option value="PT LEREGARD PRO BALI">PT LEREGARD PRO BALI</option>
                        <option value="PT CHUNK THE FUTURE">PT CHUNK THE FUTURE</option>
                        <option value="PT THE BALI PARADIS">PT THE BALI PARADIS</option>
                        <option value="PT SEA YOU BALI">PT SEA YOU BALI</option>
                        <option value="THE DOG PARADISE">THE DOG PARADISE</option>
                    </select>
                </div>
                
                <script>
                    // Add search functionality to filter the dropdown
                    function filterCompanies() {
                        let input = document.getElementById('companySearch');
                        let filter = input.value.toLowerCase();
                        let options = document.getElementById('company').options;
                
                        for (let i = 0; i < options.length; i++) {
                            let option = options[i];
                            if (option.text.toLowerCase().includes(filter)) {
                                option.style.display = ""; // Show option if it matches
                            } else {
                                option.style.display = "none"; // Hide option if it doesn't match
                            }
                        }
                    }
                </script>
            </div>
            <div>
                <label for="question" class="block text-gray-700 text-sm font-bold mb-2">Question:</label>
                <textarea id="question" name="question" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline h-32 resize-y" required></textarea>
            </div>
            <div>
                <label for="questionBy" class="block text-gray-700 text-sm font-bold mb-2">Question By (PIC):</label>
                <select id="questionBy" name="questionBy" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                    <option value="" disabled selected>Select PIC</option>
                    <option value="Esa">Esa</option>
                    <option value="Bayu">Bayu</option>
                    <option value="Kak Eko">Kak Eko</option>
                    <option value="Eka">Eka</option>
                </select>
            </div>
            <div>
                <label for="attachment" class="block text-gray-700 text-sm font-bold mb-2">Question Attachment (Link):</label>
                <input type="url" id="attachment" name="attachment" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
            </div>
            <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">Submit Issue</button>
        </form>
    </div>

    <div class="filter-container bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Filter by Month</h2>
        <select id="monthFilter" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
            <option value="">All Months</option>
            <option value="January">January</option>
            <option value="February">February</option>
            <option value="March">March</option>
            <option value="April">April</option>
            <option value="May">May</option>
            <option value="June">June</option>
            <option value="July">July</option>
            <option value="August">August</option>
            <option value="September">September</option>
            <option value="October">October</option>
            <option value="November">November</option>
            <option value="December">December</option>
        </select>
    </div>

    <div class="report-list-container bg-white rounded-lg shadow-md p-6 mb-6">
        <div class="flex justify-between mb-4">
            <h2 class="text-xl font-semibold text-gray-800">Reported Issues</h2>
            <div>
                <button id="exportButton" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline mr-2">
                    Export Data to CSV
                </button>
                <button id="refreshButton" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                    Refresh Data
                </button>
            </div>
        </div>
        <div id="reportList" class="table-responsive">
            <div class="flex justify-center items-center h-24">
                <div class="spinner"></div>
                <p class="ml-3">Loading data...</p>
            </div>
        </div>
    </div>

    <div class="response-container bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Response</h2>
        <div id="response" class="border rounded p-4 text-gray-700">
            <p>Awaiting issue submission...</p>
        </div>
    </div>

     <div class="answer-form-container bg-white rounded-lg shadow-md p-8 mt-6" style="display: none;">
        <h2 class="text-xl font-semibold text-gray-800 mb-6">Answer Issue</h2>
        <form id="answerForm" class="space-y-4">
            <input type="hidden" id="issueId" name="issueId">
            <div>
                <label for="issueNumber" class="block text-gray-700 text-sm font-bold mb-2">Issue Number:</label>
                <input type="text" id="issueNumber" name="issueNumber" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required readonly>
            </div>
            <div>
                <label for="answer" class="block text-gray-700 text-sm font-bold mb-2">Answer:</label>
                <textarea id="answer" name="answer" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline h-32 resize-y" required></textarea>
            </div>
            <div>
                <label for="answerAttachment" class="block text-gray-700 text-sm font-bold mb-2">Answer Attachment (Link):</label>
                <input type="url" id="answerAttachment" name="answerAttachment" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
            </div>
            <div class="flex justify-between">
                <button type="submit" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">Submit Answer</button>
                <button type="button" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline cancel-answer-form">Cancel</button>
            </div>
        </form>
    </div>

    <script>
        // Initialize Supabase client
        const SUPABASE_URL = 'YOUR_SUPABASE_URL'; // Replace with your Supabase URL
        const SUPABASE_KEY = 'YOUR_SUPABASE_ANON_KEY'; // Replace with your Supabase anon key
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // Initialize variables
        let issues = [];
        
        // Load data when the page is loaded
        document.addEventListener('DOMContentLoaded', function() {
            loadIssues();
            
            // Add event listeners for buttons
            document.getElementById('exportButton').addEventListener('click', exportToCSV);
            document.getElementById('refreshButton').addEventListener('click', loadIssues);
        });

        // Load issues from Supabase
        async function loadIssues() {
            showLoading();
            
            try {
                // Fetch issues from Supabase
                const { data, error } = await supabase
                    .from('tax_issues')
                    .select('*')
                    .order('issue_number', { ascending: true });
                
                if (error) throw error;
                
                issues = data || [];
                updateReportList();
            } catch (error) {
                console.error('Error loading issues:', error);
                document.getElementById('reportList').innerHTML = `
                    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
                        <strong class="font-bold">Error!</strong>
                        <span class="block sm:inline"> Failed to load issues. Please try again later.</span>
                    </div>
                `;
            }
        }
        
        // Show loading indicator
        function showLoading() {
            document.getElementById('reportList').innerHTML = `
                <div class="flex justify-center items-center h-24">
                    <div class="spinner"></div>
                    <p class="ml-3">Loading data...</p>
                </div>
            `;
        }

        // Handle issue form submission
        document.getElementById('issueForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Disable submit button and show loading state
            const submitButton = this.querySelector('button[type="submit"]');
            const originalButtonText = submitButton.innerHTML;
            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="flex items-center justify-center"><div class="spinner mr-2" style="width: 20px; height: 20px;"></div>Submitting...</span>';
            
            let formData = new FormData(this);
            let responseDiv = document.getElementById('response');
            responseDiv.innerHTML = '<p class="text-gray-600">Submitting issue...</p>';
            
            try {
                // Get the highest issue number to determine the next one
                const { data: maxIssueNumber, error: maxError } = await supabase
                    .from('tax_issues')
                    .select('issue_number')
                    .order('issue_number', { ascending: false })
                    .limit(1);
                
                if (maxError) throw maxError;
                
                const nextIssueNumber = maxIssueNumber && maxIssueNumber.length > 0 
                    ? maxIssueNumber[0].issue_number + 1 
                    : 1;
                
                // Create new issue object
                const newIssue = {
                    issue_number: nextIssueNumber,
                    period: formData.get('period'),
                    company: formData.get('company'),
                    question: formData.get('question'),
                    question_by: formData.get('questionBy'),
                    attachment: formData.get('attachment') || null,
                    status: "NEW / OPEN",
                    answer: null,
                    answer_attachment: null
                };
                
                // Insert the new issue into Supabase
                const { data, error } = await supabase
                    .from('tax_issues')
                    .insert([newIssue])
                    .select();
                
                if (error) throw error;
                
                // Reset form and reload issues
                this.reset();
                await loadIssues();
                
                // Display success response
                displayResponse(nextIssueNumber);
                
                // Show success message
                responseDiv.innerHTML = `
                    <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-4" role="alert">
                        <strong class="font-bold">Success!</strong>
                        <span class="block sm:inline"> Issue #${nextIssueNumber} has been created.</span>
                    </div>
                    ${responseDiv.innerHTML}
                `;
            } catch (error) {
                console.error('Error submitting issue:', error);
                responseDiv.innerHTML = `
                    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
                        <strong class="font-bold">Error!</strong>
                        <span class="block sm:inline"> Failed to submit issue. Please try again later.</span>
                    </div>
                `;
            } finally {
                // Re-enable submit button
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonText;
            }
        });

        // Filter issues by month
        document.getElementById('monthFilter').addEventListener('change', function() {
            updateReportList();
        });

        // Update the report list display
        function updateReportList() {
            let reportListDiv = document.getElementById('reportList');
            let selectedMonth = document.getElementById('monthFilter').value;

            if (issues.length === 0) {
                reportListDiv.innerHTML = '<p>No issues reported yet.</p>';
                return;
            }

            let filteredIssues = issues; // Start with all issues
            if (selectedMonth) {
                filteredIssues = issues.filter(issue => issue.period === selectedMonth);
            }

            let reportListHTML = `<div class="table-responsive">
                <table class="min-w-full border-collapse border border-gray-300">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="px-4 py-2 border border-gray-300 text-left">Issue #</th>
                            <th class="px-4 py-2 border border-gray-300 text-left">Period</th>
                            <th class="px-4 py-2 border border-gray-300 text-left">Company</th>
                            <th class="px-4 py-2 border border-gray-300 text-left">Question</th>
                            <th class="px-4 py-2 border border-gray-300 text-left">Question By (PIC)</th>
                            <th class="px-4 py-2 border border-gray-300 text-left">Attachment</th>
                            <th class="px-4 py-2 border border-gray-300 text-left">Status</th>
                            <th class="px-4 py-2 border border-gray-300 text-left">Answer</th>
                            <th class="px-4 py-2 border border-gray-300 text-left">Answer Attachment</th>
                            <th class="px-4 py-2 border border-gray-300 text-left">Action</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white">
                        ${filteredIssues.map((issue) => {
                            return `
                                <tr>
                                    <td class="px-4 py-2 border border-gray-300">${issue.issue_number}</td>
                                    <td class="px-4 py-2 border border-gray-300">${issue.period}</td>
                                    <td class="px-4 py-2 border border-gray-300">${issue.company}</td>
                                    <td class="px-4 py-2 border border-gray-300">${issue.question}</td>
                                    <td class="px-4 py-2 border border-gray-300">${issue.question_by}</td>
                                    <td class="px-4 py-2 border border-gray-300">${issue.attachment ? `<a href="${issue.attachment}" target="_blank" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-2 rounded focus:outline-none focus:shadow-outline inline-block ml-2 text-sm">Here</a>` : 'No attachment'}</td>
                                     <td class="px-4 py-2 border border-gray-300"><span class="${getStatusColor(issue.status)} py-1 px-3 rounded-full text-xs font-semibold">${issue.status}</span></td>
                                    <td class="px-4 py-2 border border-gray-300">${issue.answer ? issue.answer : 'Awaiting Answer'}</td>
                                    <td class="px-4 py-2 border border-gray-300">${issue.answer_attachment ? `<a href="${issue.answer_attachment}" target="_blank" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-2 rounded focus:outline-none focus:shadow-outline inline-block ml-2 text-sm">Here</a>` : 'No attachment'}</td>
                                    <td class="px-4 py-2 border border-gray-300">
                                        ${issue.answer ? 
                                          `<button class="bg-yellow-500 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline mb-2 edit-answer-button" data-id="${issue.id}" data-issue-number="${issue.issue_number}">Edit Answer</button>
                                           <button class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline delete-button" data-id="${issue.id}" data-issue-number="${issue.issue_number}">Delete</button>` 
                                        : 
                                          `<button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline mb-2 answer-button" data-id="${issue.id}" data-issue-number="${issue.issue_number}">Answer Issue</button>
                                           <button class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline delete-button" data-id="${issue.id}" data-issue-number="${issue.issue_number}">Delete</button>`}
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>`;

            reportListDiv.innerHTML = reportListHTML;

            // Attach event listeners to the buttons
            document.querySelectorAll('.answer-button, .edit-answer-button').forEach(button => {
                button.addEventListener('click', function() {
                    const issueId = this.dataset.id;
                    const issueNumber = parseInt(this.dataset.issueNumber);
                    showAnswerForm(issueId, issueNumber);
                });
            });
            
            // Add event listeners for delete buttons
            document.querySelectorAll('.delete-button').forEach(button => {
                button.addEventListener('click', function() {
                    const issueId = this.dataset.id;
                    const issueNumber = parseInt(this.dataset.issueNumber);
                    if (confirm(`Are you sure you want to delete issue #${issueNumber}? This cannot be undone.`)) {
                        deleteIssue(issueId, issueNumber);
                    }
                });
            });
        }

        // Delete an issue
        async function deleteIssue(issueId, issueNumber) {
            try {
                const { error } = await supabase
                    .from('tax_issues')
                    .delete()
                    .eq('id', issueId);
                
                if (error) throw error;
                
                // Reload issues after deletion
                await loadIssues();
                
                // Update response div
                document.getElementById('response').innerHTML = `
                    <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative" role="alert">
                        <strong class="font-bold">Success!</strong>
                        <span class="block sm:inline"> Issue #${issueNumber} has been deleted.</span>
                    </div>
                `;
            } catch (error) {
                console.error('Error deleting issue:', error);
                document.getElementById('response').innerHTML = `
                    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
                        <strong class="font-bold">Error!</strong>
                        <span class="block sm:inline"> Failed to delete issue. Please try again later.</span>
                    </div>
                `;
            }
        }

        // Show answer form
        function showAnswerForm(issueId, issueNumber) {
            let answerFormContainer = document.querySelector('.answer-form-container');
            
            // Set issue ID and number
            document.getElementById('issueId').value = issueId;
            document.getElementById('issueNumber').value = issueNumber;
            
            // Find the issue in the array
            const issueToAnswer = issues.find(issue => issue.id === issueId);
            if (issueToAnswer) {
                document.getElementById('answer').value = issueToAnswer.answer || '';
                document.getElementById('answerAttachment').value = issueToAnswer.answer_attachment || '';
            }
            
            answerFormContainer.style.display = 'block';
        }

        // Handle cancel button on answer form
        document.querySelector('.cancel-answer-form').addEventListener('click', function(e) {
            e.preventDefault();
            document.querySelector('.answer-form-container').style.display = 'none';
            document.getElementById('answerForm').reset();
        });

        // Handle answer form submission
        document.getElementById('answerForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Disable submit button and show loading state
            const submitButton = this.querySelector('button[type="submit"]');
            const originalButtonText = submitButton.innerHTML;
            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="flex items-center justify-center"><div class="spinner mr-2" style="width: 20px; height: 20px;"></div>Submitting...</span>';
            
            const issueId = document.getElementById('issueId').value;
            const issueNumber = parseInt(document.getElementById('issueNumber').value);
            const answer = document.getElementById('answer').value;
            const answerAttachment = document.getElementById('answerAttachment').value || null;
            
            try {
                // Update the issue in Supabase
                const { data, error } = await supabase
                    .from('tax_issues')
                    .update({ 
                        answer: answer,
                        answer_attachment: answerAttachment,
                        status: "ANSWERED",
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', issueId)
                    .select();
                
                if (error) throw error;
                
                // Reload issues
                await loadIssues();
                
                // Hide the form
                document.querySelector('.answer-form-container').style.display = 'none';
                document.getElementById('answerForm').reset();
                
                // Display updated issue
                displayResponse(issueNumber);
                
                // Show success message
                document.getElementById('response').innerHTML = `
                    <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-4" role="alert">
                        <strong class="font-bold">Success!</strong>
                        <span class="block sm:inline"> Answer for issue #${issueNumber} has been submitted.</span>
                    </div>
                    ${document.getElementById('response').innerHTML}
                `;
            } catch (error) {
                console.error('Error submitting answer:', error);
                document.getElementById('response').innerHTML = `
                    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
                        <strong class="font-bold">Error!</strong>
                        <span class="block sm:inline"> Failed to submit answer. Please try again later.</span>
                    </div>
                `;
            } finally {
                // Re-enable submit button
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonText;
            }
        });

        // Get status color class
        function getStatusColor(status) {
            switch (status) {
                case "NEW / OPEN": return "bg-yellow-200 text-yellow-700";
                case "ANSWERED": return "bg-green-200 text-green-700";
                case "CLOSED": return "bg-gray-200 text-gray-700";
                default: return "bg-gray-200 text-gray-700";
            }
        }

        // Display issue details in response area
        function displayResponse(issueNumber) {
            let responseDiv = document.getElementById('response');
            const issue = issues.find(i => i.issue_number === issueNumber);

            if (issue) {
                responseDiv.innerHTML = `<div class="mb-4">
                        <p><span class="font-semibold">Issue Number:</span> ${issue.issue_number}</p>
                        <p><span class="font-semibold">Period:</span> ${issue.period}</p>
                        <p><span class="font-semibold">Company:</span> ${issue.company}</p>
                        <p><span class="font-semibold">Question:</span> ${issue.question}</p>
                        <p><span class="font-semibold">Question By (PIC):</span> ${issue.question_by}</p>
                        <p><span class="font-semibold">Question Attachment:</span> ${issue.attachment ? `<a href="${issue.attachment}" target="_blank" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-2 rounded focus:outline-none focus:shadow-outline inline-block ml-2 text-sm">Here</a>` : 'No attachment'}</p>
                    </div>
                    <div class="mb-4 border-t border-gray-200 pt-4">
                        <p><span class="font-semibold">Answer:</span> ${issue.answer ? issue.answer : 'Awaiting Answer'}</p>
                        <p><span class="font-semibold">Answer Attachment:</span> ${issue.answer_attachment ? `<a href="${issue.answer_attachment}" target="_blank" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-2 rounded focus:outline-none focus:shadow-outline inline-block ml-2 text-sm">Here</a>` : 'No attachment'}</p>
                    </div>
                    <div class="mb-4 border-t border-gray-200 pt-4">
                        <p><span class="font-semibold">Status:</span> <span class="${getStatusColor(issue.status)} py-1 px-3 rounded-full text-xs font-semibold">${issue.status}</span></p>
                    </div>`;
            } else {
                responseDiv.innerHTML = `<p>No issue found with issue number ${issueNumber}</p>`;
            }
        }
        
        // Export data to CSV
        function exportToCSV() {
            if (issues.length === 0) {
                alert('No data to export');
                return;
            }
            
            // Define CSV headers
            const headers = [
                'Issue #',
                'Period',
                'Company',
                'Question',
                'Question By (PIC)',
                'Attachment',
                'Status',
                'Answer',
                'Answer Attachment',
                'Date Created',
                'Date Updated'
            ];
            
            // Map issues to CSV rows
            const rows = issues.map(issue => [
                issue.issue_number,
                issue.period,
                issue.company,
                issue.question,
                issue.question_by,
                issue.attachment || '',
                issue.status,
                issue.answer || '',
                issue.answer_attachment || '',
                new Date(issue.created_at).toLocaleString(),
                issue.updated_at ? new Date(issue.updated_at).toLocaleString() : ''
            ]);
            
            // Combine headers and rows
            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
            ].join('\n');
            
            // Create a Blob and download link
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            
            // Set download attributes
            link.setAttribute('href', url);
            link.setAttribute('download', `tax_issues_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.display = 'none';
            
            // Append to body, trigger click, and clean up
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
