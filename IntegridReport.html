<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integrid Tax Issue Reporting System</title>
    <link rel="icon" href="/favico.png" type="image/x-icon">
    <link rel="shortcut icon" href="/favico.png" type="image/x-icon">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Supabase JS Client -->
    <script src="https://unpkg.com/@supabase/supabase-js@2.38.4/dist/umd/supabase.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .table-container {
            overflow-x: auto;
            margin-bottom: 20px;
        }
        .table-responsive {
            width: 100%;
            overflow-x: auto;
        }
        .table-responsive table {
            min-width: 800px;
        }
        
        /* Custom Dropdown Styles */
        .custom-dropdown {
            position: relative;
            width: 100%;
        }
        
        .dropdown-btn {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 10px 15px;
            background-color: #0D9F6F; /* Green color as in your image */
            color: white;
            border: none;
            cursor: pointer;
            text-align: left;
        }
        
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: white;
            width: 100%;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 10;
            border: 1px solid #f1f1f1;
        }
        
        .dropdown-content.show {
            display: block;
        }
        
        .search-container {
            padding: 10px;
            border-bottom: 1px solid #f1f1f1;
            display: flex;
            align-items: center;
        }
        
        .search-container input {
            width: 100%;
            border: none;
            padding: 5px;
            outline: none;
        }
        
        .search-icon {
            color: #aaa;
            margin-right: 10px;
        }
        
        .dropdown-options {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .dropdown-item {
            padding: 12px 16px;
            cursor: pointer;
        }
        
        .dropdown-item:hover {
            background-color: #f9f9f9;
        }
        
        /* Loading spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #3b82f6;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 p-6 rounded-lg">
    <h1 class="text-4xl font-bold text-center text-blue-700 mb-8 border-2 border-blue-400 rounded-md p-4">Integrid Tax Issue Reporting System</h1>

    <div class="bg-white rounded-lg shadow-md p-6 mb-8 border-2 border-gray-300">
        <h2 class="text-xl font-semibold text-gray-800 mb-4 underline">Important Information</h2>
        <ol class="list-decimal list-inside space-y-2">
            <li class="flex items-start">
                <span class="font-semibold mr-1">PLEASE UPLOAD THE QUESTION ATTACHMENT FILE ON THIS DRIVE :</span> 
                    <a href="https://drive.google.com/drive/folders/1TtYH6e1c3nIP-uHX_mPEqcVKIjNr2-iT?usp=drive_link" target="_blank" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-2 rounded focus:outline-none focus:shadow-outline inline-block ml-2 text-sm">
                        Here
                    </a>
                
            </li>
            <li class="flex items-start">
                <span class="font-semibold mr-1">PLEASE UPLOAD THE ANSWER ATTACHMENT FILE ON THIS DRIVE :</span>
                    <a href="https://drive.google.com/drive/folders/1ihFleQ0ONU4S9C-cjmlkJZov1RuvYjvk?usp=drive_link" target="_blank" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-2 rounded focus:outline-none focus:shadow-outline inline-block ml-2 text-sm">
                        Here
                    </a>
                
            </li>
        </ol>
    </div>

    <div class="form-container bg-white rounded-lg shadow-md p-8 mb-6">
        <h2 class="text-xl font-semibold text-gray-800 mb-6">Report an Issue</h2>
        <form id="issueForm" class="space-y-4">
            <div>
                <label for="period" class="block text-gray-700 text-sm font-bold mb-2">Period:</label>
                <select id="period" name="period" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                    <option value="" disabled selected>Select Month</option>
                    <option value="January">January</option>
                    <option value="February">February</option>
                    <option value="March">March</option>
                    <option value="April">April</option>
                    <option value="May">May</option>
                    <option value="June">June</option>
                    <option value="July">July</option>
                    <option value="August">August</option>
                    <option value="September">September</option>
                    <option value="October">October</option>
                    <option value="November">November</option>
                    <option value="December">December</option>
                </select>
            </div>
            <div>
                <label for="company" class="block text-gray-700 text-sm font-bold mb-2">Company:</label>
                <div class="custom-dropdown" id="companyFormDropdown">
                    <button type="button" class="dropdown-btn">
                        <span class="selected-text">Select Company</span>
                        <span>‚ñº</span>
                    </button>
                    <div class="dropdown-content">
                        <div class="search-container">
                            <span class="search-icon">üîç</span>
                            <input type="text" placeholder="Search..." class="dropdown-search">
                        </div>
                        <div class="dropdown-options">
                            <!-- Options will be populated here -->
                        </div>
                    </div>
                    <input type="hidden" id="company" name="company" required>
                </div>
            </div>
            <div>
                <label for="question" class="block text-gray-700 text-sm font-bold mb-2">Question:</label>
                <textarea id="question" name="question" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline h-32 resize-y" required></textarea>
            </div>
            <div>
                <label for="questionBy" class="block text-gray-700 text-sm font-bold mb-2">Question By (PIC):</label>
                <select id="questionBy" name="questionBy" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                    <option value="" disabled selected>Select PIC</option>
                    <option value="Esa">Esa</option>
                    <option value="Bayu">Bayu</option>
                    <option value="Kak Eko">Kak Eko</option>
                    <option value="Eka">Eka</option>
                </select>
            </div>
            <div>
                <label for="attachment" class="block text-gray-700 text-sm font-bold mb-2">Question Attachment (Link):</label>
                <input type="url" id="attachment" name="attachment" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
            </div>
            <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">Submit Issue</button>
        </form>
    </div>

    <div class="filter-container bg-white rounded-lg shadow-md p-6 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Filter by Month</h2>
                <select id="monthFilter" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    <option value="">All Months</option>
                    <option value="January">January</option>
                    <option value="February">February</option>
                    <option value="March">March</option>
                    <option value="April">April</option>
                    <option value="May">May</option>
                    <option value="June">June</option>
                    <option value="July">July</option>
                    <option value="August">August</option>
                    <option value="September">September</option>
                    <option value="October">October</option>
                    <option value="November">November</option>
                    <option value="December">December</option>
                </select>
            </div>
            <div>
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Filter by Company</h2>
                <div class="custom-dropdown" id="companyFilterDropdown">
                    <button type="button" class="dropdown-btn">
                        <span class="selected-text">All Companies</span>
                        <span>‚ñº</span>
                    </button>
                    <div class="dropdown-content">
                        <div class="search-container">
                            <span class="search-icon">üîç</span>
                            <input type="text" placeholder="Search..." class="dropdown-search">
                        </div>
                        <div class="dropdown-options">
                            <!-- Filter options will be populated here -->
                        </div>
                    </div>
                    <input type="hidden" id="companyFilter" name="companyFilter">
                </div>
            </div>
        </div>
    </div>

    <div class="report-list-container bg-white rounded-lg shadow-md p-6 mb-6">
        <div class="flex justify-between mb-4">
            <h2 class="text-xl font-semibold text-gray-800">Reported Issues</h2>
            <div>
                <button id="exportButton" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline mr-2">
                    Export Data to CSV
                </button>
                <button id="refreshButton" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                    Refresh Data
                </button>
            </div>
        </div>
        <div id="reportList" class="table-responsive">
            <div class="flex justify-center items-center h-24">
                <div class="spinner"></div>
                <p class="ml-3">Loading data...</p>
            </div>
        </div>
    </div>

    <div class="response-container bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Response</h2>
        <div id="response" class="border rounded p-4 text-gray-700">
            <p>Awaiting issue submission...</p>
        </div>
    </div>

     <div class="answer-form-container bg-white rounded-lg shadow-md p-8 mt-6" style="display: none;">
        <h2 class="text-xl font-semibold text-gray-800 mb-6">Answer Issue</h2>
        <form id="answerForm" class="space-y-4">
            <input type="hidden" id="issueId" name="issueId">
            <div>
                <label for="issueNumber" class="block text-gray-700 text-sm font-bold mb-2">Issue Number:</label>
                <input type="text" id="issueNumber" name="issueNumber" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required readonly>
            </div>
            <div>
                <label for="answer" class="block text-gray-700 text-sm font-bold mb-2">Answer:</label>
                <textarea id="answer" name="answer" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline h-32 resize-y" required></textarea>
            </div>
            <div>
                <label for="answerAttachment" class="block text-gray-700 text-sm font-bold mb-2">Answer Attachment (Link):</label>
                <input type="url" id="answerAttachment" name="answerAttachment" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
            </div>
            <div class="flex justify-between">
                <button type="submit" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">Submit Answer</button>
                <button type="button" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline cancel-answer-form">Cancel</button>
            </div>
        </form>
    </div>

    <script>
        // Initialize Supabase client
        const SUPABASE_URL = 'https://rflwewfwmuwxgulptqrv.supabase.co'; // Replace with your Supabase URL
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJmbHdld2Z3bXV3eGd1bHB0cXJ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU0OTIzNTEsImV4cCI6MjA2MTA2ODM1MX0.QIJ2Gr1GdHYmIxBl5aY3YpyCUz1HqSpBrT8UppdQU5o'; // Replace with your Supabase anon key
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Company list for the dropdown
        const companyList = [
            "The Bluejay", "Barong Family", "Sababa - Elno Noli Putih", "Karisa Lifestyle",
            "Indah Nusa Timur", "INTEGRID", "Gelareh Design", "Sunkiss Restaurant",
            "Rent Surfboard Bali", "Improvea Maju Solusi", "Trio Rukun Sejahtera",
            "Ola Casa Bali", "Moonkey Group", "Anugrah Pangan Jaya (CIBO)", "Liva",
            "You Spa Bali", "Pemandangan HIjau Bali", "Kayu Living Bali",
            "Serenity Property Bali", "Weddingup Event Organizer", "Bienaime Samyn Investment",
            "Bali Couple Retreats", "Denpasar Indah Seruni", "Maza Bali Investing",
            "Martin Family Agency", "Masa Depan Utama Lestari", "Sportva",
            "JGM Group Management", "Naoli Eliam Group", "Evasion Villa Bali",
            "Pauline & Luke Consulting", "Bali Real Estate - Anjuna Bay", "HMZ Digital Agency",
            "Shade Agency Bali", "Mid Night Sun", "Neala Nature Stays",
            "Deprince Global Services", "Lucky Cat Land", "Only Loading Asia",
            "Women Bali Bahagia", "Sunder Jupiter Bali", "Aanoukis Tropix Retail",
            "Bybali Build Consulting", "Snaaack Padang Bai", "The Naluri Bali",
            "Hocus Pocus Prod", "Kim Advantage Consulting", "Bejoi Design Bali",
            "Nyata Consulting Bali", "Tran Manh Sung", "The Blackless Lovers",
            "Maju Operation & Development", "Dragon Indonesia Exotics", "Elodie Mattei Group",
            "Chatelain Advisory Investment", "Cabana Bali Style", "Good Move",
            "Slow Nomad Living", "The Agency Bali", "Esensi Digital Agency",
            "LNH Reality and Flavor", "MYMS", "Modern Groove Reverie",
            "PT. LUNES SACREES BALI", "PT. JOY BIRD INVEST", "PT. WEAREBRAND PRODUCTION DIGITAL",
            "PT. BEBAS EXPERIENCE GROUP", "PT. THE SUNRISE PRODUCTION", "THE BACKLESS LOVERS",
            "PT THE CENTURY GROUP", "BALI ISLAND BOUNCE", "PT BALI JADAYO IMMO",
            "PT DEL VALLE GURRUTXAGA", "PT THE SURFER GUIDE BALI", "PT CALA BALI INVESTMENT",
            "PT LEREGARD PRO BALI", "PT CHUNK THE FUTURE", "PT THE BALI PARADIS",
            "PT SEA YOU BALI", "THE DOG PARADISE"
        ];
        
        // Initialize variables
        let issues = [];
        
        // Load data when the page is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize custom dropdowns
            initDropdown('companyFormDropdown', companyList, true, (value) => {
                document.getElementById('company').value = value;
            });
            
            // Initialize filter dropdown with "All Companies" option
            initDropdown('companyFilterDropdown', ["All Companies"].concat(companyList), false, (value) => {
                if (value === "All Companies") {
                    document.getElementById('companyFilter').value = "";
                } else {
                    document.getElementById('companyFilter').value = value;
                }
                updateReportList();
            });
            
            loadIssues();
            
            // Add event listeners for buttons
            document.getElementById('exportButton').addEventListener('click', exportToCSV);
            document.getElementById('refreshButton').addEventListener('click', loadIssues);
            document.getElementById('monthFilter').addEventListener('change', updateReportList);
        });
        
        // Initialize custom dropdown
        function initDropdown(dropdownId, options, isRequired, onSelect) {
            const dropdown = document.getElementById(dropdownId);
            const btn = dropdown.querySelector('.dropdown-btn');
            const content = dropdown.querySelector('.dropdown-content');
            const searchInput = content.querySelector('.dropdown-search');
            const optionsContainer = content.querySelector('.dropdown-options');
            const selectedText = btn.querySelector('.selected-text');
            
            // Populate dropdown options
            populateDropdownOptions(optionsContainer, options, (value) => {
                selectedText.textContent = value;
                onSelect(value);
                content.classList.remove('show');
            });
            
            // Toggle dropdown
            btn.addEventListener('click', function() {
                content.classList.toggle('show');
                if (content.classList.contains('show')) {
                    searchInput.focus();
                    // Reset search each time
                    searchInput.value = '';
                    filterDropdownOptions(optionsContainer, '');
                }
            });
            
            // Search functionality
            searchInput.addEventListener('input', function() {
                filterDropdownOptions(optionsContainer, this.value);
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!dropdown.contains(e.target)) {
                    content.classList.remove('show');
                }
            });
            
            // Validate required field if needed
            if (isRequired) {
                // This is for form validation
                // You might need to add more logic based on your form submission needs
            }
        }
        
        // Populate dropdown options
        function populateDropdownOptions(container, options, onSelect) {
            container.innerHTML = '';
            options.forEach(option => {
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                item.textContent = option;
                item.addEventListener('click', () => onSelect(option));
                container.appendChild(item);
            });
        }
        
        // Filter dropdown options
        function filterDropdownOptions(container, searchText) {
            const items = container.querySelectorAll('.dropdown-item');
            const searchLower = searchText.toLowerCase();
            
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(searchLower)) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        // Update company filter dropdown based on current issues
        function updateCompanyFilterDropdown() {
            // Get unique companies from issues
            const companies = issues.map(issue => issue.company);
            const uniqueCompanies = [...new Set(companies)].filter(Boolean).sort();
            
            // Update the dropdown options
            const optionsContainer = document.querySelector('#companyFilterDropdown .dropdown-options');
            populateDropdownOptions(optionsContainer, ["All Companies"].concat(uniqueCompanies), (value) => {
                if (value === "All Companies") {
                    document.getElementById('companyFilter').value = "";
                } else {
                    document.getElementById('companyFilter').value = value;
                }
                document.querySelector('#companyFilterDropdown .selected-text').textContent = value;
                document.querySelector('#companyFilterDropdown .dropdown-content').classList.remove('show');
                updateReportList();
            });
        }

        // Load issues from Supabase
        async function loadIssues() {
            showLoading();
            
            try {
                // Fetch issues from Supabase
                const { data, error } = await supabaseClient
                    .from('tax_issues')
                    .select('*')
                    .order('issue_number', { ascending: true });
                
                if (error) throw error;
                
                issues = data || [];
                updateReportList();
                
                // Update company filter dropdown with current companies
                updateCompanyFilterDropdown();
            } catch (error) {
                console.error('Error loading issues:', error);
                document.getElementById('reportList').innerHTML = `
                    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
                        <strong class="font-bold">Error!</strong>
                        <span class="block sm:inline"> Failed to load issues. Please try again later.</span>
                    </div>
                `;
            }
        }
        
        // Show loading indicator
        function showLoading() {
            document.getElementById('reportList').innerHTML = `
                <div class="flex justify-center items-center h-24">
                    <div class="spinner"></div>
                    <p class="ml-3">Loading data...</p>
                </div>
            `;
        }

        // Handle issue form submission
        document.getElementById('issueForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Validate company selection
            if (!document.getElementById('company').value) {
                alert('Please select a company');
                return;
            }
            
            // Disable submit button and show loading state
            const submitButton = this.querySelector('button[type="submit"]');
            const originalButtonText = submitButton.innerHTML;
            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="flex items-center justify-center"><div class="spinner mr-2" style="width: 20px; height: 20px;"></div>Submitting...</span>';
            
            let formData = new FormData(this);
            let responseDiv = document.getElementById('response');
            responseDiv.innerHTML = '<p class="text-gray-600">Submitting issue...</p>';
            
            try {
                // Get the highest issue number to determine the next one
                const { data: maxIssueNumber, error: maxError } = await supabaseClient
                    .from('tax_issues')
                    .select('issue_number')
                    .order('issue_number', { ascending: false })
                    .limit(1);
                
                if (maxError) throw maxError;
                
                const nextIssueNumber = maxIssueNumber && maxIssueNumber.length > 0 
                    ? maxIssueNumber[0].issue_number + 1 
                    : 1;
                
                // Create new issue object
                const newIssue = {
                    issue_number: nextIssueNumber,
                    period: formData.get('period'),
                    company: formData.get('company'),
                    question: formData.get('question'),
                    question_by: formData.get('questionBy'),
                    attachment: formData.get('attachment') || null,
                    status: "NEW / OPEN",
                    answer: null,
                    answer_attachment: null
                };
                
                // Insert the new issue into Supabase
                const { data, error } = await supabaseClient
                    .from('tax_issues')
                    .insert([newIssue])
                    .select();
                
                if (error) throw error;
                
                // Reset form and dropdown
                this.reset();
                document.querySelector('#companyFormDropdown .selected-text').textContent = 'Select Company';
                document.getElementById('company').value = '';
                
                await loadIssues();
                
                // Display success response
                displayResponse(nextIssueNumber);
                
                // Show success message
                responseDiv.innerHTML = `
                    <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-4" role="alert">
                        <strong class="font-bold">Success!</strong>
                        <span class="block sm:inline"> Issue #${nextIssueNumber} has been created.</span>
                    </div>
                    ${responseDiv.innerHTML}
                `;
            } catch (error) {
                console.error('Error submitting issue:', error);
                if (error.details) console.error('Error details:', error.details);
                if (error.hint) console.error('Error hint:', error.hint);
                if (error.code) console.error('Error code:', error.code);
                responseDiv.innerHTML = `
                    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
                        <strong class="font-bold">Error!</strong>
                        <span class="block sm:inline"> Failed to submit issue. Please try again later.</span>
                    </div>
                `;
            } finally {
                // Re-enable submit button
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonText;
            }
        });

        // Update the report list display
        function updateReportList() {
            let reportListDiv = document.getElementById('reportList');
            let selectedMonth = document.getElementById('monthFilter').value;
            let selectedCompany = document.getElementById('companyFilter').value;

            if (issues.length === 0) {
                reportListDiv.innerHTML = '<p>No issues reported yet.</p>';
                return;
            }

            let filteredIssues = issues; // Start with all issues
            
            // Apply month filter if selected
            if (selectedMonth) {
                filteredIssues = filteredIssues.filter(issue => issue.period === selectedMonth);
            }
            
            // Apply company filter if selected
            if (selectedCompany) {
                filteredIssues = filteredIssues.filter(issue => issue.company === selectedCompany);
            }

            let reportListHTML = `<div class="table-responsive">
                <table class="min-w-full border-collapse border border-gray-300">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="px-4 py-2 border border-gray-300 text-left">Issue #</th>
                            <th class="px-4 py-2 border border-gray-300 text-left">Period</th>
                            <th class="px-4 py-2 border border-gray-300 text-left">Company</th>
                            <th class="px-4 py-2 border border-gray-300 text-left">Question</th>
                            <th class="px-4 py-2 border border-gray-300 text-left">Question By (PIC)</th>
                            <th class="px-4 py-2 border border-gray-300 text-left">Attachment</th>
                            <th class="px-4 py-2 border border-gray-300 text-left">Status</th>
                            <th class="px-4 py-2 border border-gray-300 text-left">Answer</th>
                            <th class="px-4 py-2 border border-gray-300 text-left">Answer Attachment</th>
                            <th class="px-4 py-2 border border-gray-300 text-left">Action</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white">
                        ${filteredIssues.map((issue) => {
                            return `
                                <tr>
                                    <td class="px-4 py-2 border border-gray-300">${issue.issue_number}</td>
                                    <td class="px-4 py-2 border border-gray-300">${issue.period}</td>
                                    <td class="px-4 py-2 border border-gray-300">${issue.company}</td>
                                    <td class="px-4 py-2 border border-gray-300">${issue.question}</td>
                                    <td class="px-4 py-2 border border-gray-300">${issue.question_by}</td>
                                    <td class="px-4 py-2 border border-gray-300">${issue.attachment ? `<a href="${issue.attachment}" target="_blank" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-2 rounded focus:outline-none focus:shadow-outline inline-block ml-2 text-sm">Here</a>` : 'No attachment'}</td>
                                     <td class="px-4 py-2 border border-gray-300"><span class="${getStatusColor(issue.status)} py-1 px-3 rounded-full text-xs font-semibold">${issue.status}</span></td>
                                    <td class="px-4 py-2 border border-gray-300">${issue.answer ? issue.answer : 'Awaiting Answer'}</td>
                                    <td class="px-4 py-2 border border-gray-300">${issue.answer_attachment ? `<a href="${issue.answer_attachment}" target="_blank" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-2 rounded focus:outline-none focus:shadow-outline inline-block ml-2 text-sm">Here</a>` : 'No attachment'}</td>
                                    <td class="px-4 py-2 border border-gray-300">
                                        ${issue.answer ? 
                                          `<button class="bg-yellow-500 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline mb-2 edit-answer-button" data-id="${issue.id}" data-issue-number="${issue.issue_number}">Edit Answer</button>
                                           <button class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline delete-button" data-id="${issue.id}" data-issue-number="${issue.issue_number}">Delete</button>` 
                                        : 
                                          `<button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline mb-2 answer-button" data-id="${issue.id}" data-issue-number="${issue.issue_number}">Answer Issue</button>
                                           <button class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline delete-button" data-id="${issue.id}" data-issue-number="${issue.issue_number}">Delete</button>`}
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>`;

            reportListDiv.innerHTML = reportListHTML;

            // Attach event listeners to the buttons
            document.querySelectorAll('.answer-button, .edit-answer-button').forEach(button => {
                button.addEventListener('click', function() {
                    const issueId = this.dataset.id;
                    const issueNumber = parseInt(this.dataset.issueNumber);
                    showAnswerForm(issueId, issueNumber);
                });
            });
            
            // Add event listeners for delete buttons
            document.querySelectorAll('.delete-button').forEach(button => {
                button.addEventListener('click', function() {
                    const issueId = this.dataset.id;
                    const issueNumber = parseInt(this.dataset.issueNumber);
                    if (confirm(`Are you sure you want to delete issue #${issueNumber}? This cannot be undone.`)) {
                        deleteIssue(issueId, issueNumber);
                    }
                });
            });
        }

        // Delete an issue
        async function deleteIssue(issueId, issueNumber) {
            try {
                const { error } = await supabaseClient
                    .from('tax_issues')
                    .delete()
                    .eq('id', issueId);
                
                if (error) throw error;
                
                // Reload issues after deletion
                await loadIssues();
                
                // Update response div
                document.getElementById('response').innerHTML = `
                    <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative" role="alert">
                        <strong class="font-bold">Success!</strong>
                        <span class="block sm:inline"> Issue #${issueNumber} has been deleted.</span>
                    </div>
                `;
            } catch (error) {
                console.error('Error deleting issue:', error);
                document.getElementById('response').innerHTML = `
                    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
                        <strong class="font-bold">Error!</strong>
                        <span class="block sm:inline"> Failed to delete issue. Please try again later.</span>
                    </div>
                `;
            }
        }

        // Show answer form
        function showAnswerForm(issueId, issueNumber) {
            let answerFormContainer = document.querySelector('.answer-form-container');
            
            // Set issue ID and number
            document.getElementById('issueId').value = issueId;
            document.getElementById('issueNumber').value = issueNumber;
            
            // Find the issue in the array
            const issueToAnswer = issues.find(issue => issue.id === issueId);
            if (issueToAnswer) {
                document.getElementById('answer').value = issueToAnswer.answer || '';
                document.getElementById('answerAttachment').value = issueToAnswer.answer_attachment || '';
            }
            
            answerFormContainer.style.display = 'block';
        }

        // Handle cancel button on answer form
        document.querySelector('.cancel-answer-form').addEventListener('click', function(e) {
            e.preventDefault();
            document.querySelector('.answer-form-container').style.display = 'none';
            document.getElementById('answerForm').reset();
        });

        // Handle answer form submission
        document.getElementById('answerForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Disable submit button and show loading state
            const submitButton = this.querySelector('button[type="submit"]');
            const originalButtonText = submitButton.innerHTML;
            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="flex items-center justify-center"><div class="spinner mr-2" style="width: 20px; height: 20px;"></div>Submitting...</span>';
            
            const issueId = document.getElementById('issueId').value;
            const issueNumber = parseInt(document.getElementById('issueNumber').value);
            const answer = document.getElementById('answer').value;
            const answerAttachment = document.getElementById('answerAttachment').value || null;
            
            try {
                // Update the issue in Supabase
                const { data, error } = await supabaseClient
                    .from('tax_issues')
                    .update({ 
                        answer: answer,
                        answer_attachment: answerAttachment,
                        status: "ANSWERED",
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', issueId)
                    .select();
                
                if (error) throw error;
                
                // Reload issues
                await loadIssues();
                
                // Hide the form
                document.querySelector('.answer-form-container').style.display = 'none';
                document.getElementById('answerForm').reset();
                
                // Display updated issue
                displayResponse(issueNumber);
                
                // Show success message
                document.getElementById('response').innerHTML = `
                    <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-4" role="alert">
                        <strong class="font-bold">Success!</strong>
                        <span class="block sm:inline"> Answer for issue #${issueNumber} has been submitted.</span>
                    </div>
                    ${document.getElementById('response').innerHTML}
                `;
            } catch (error) {
                console.error('Error submitting answer:', error);
                document.getElementById('response').innerHTML = `
                    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
                        <strong class="font-bold">Error!</strong>
                        <span class="block sm:inline"> Failed to submit answer. Please try again later.</span>
                    </div>
                `;
            } finally {
                // Re-enable submit button
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonText;
            }
        });

        // Get status color class
        function getStatusColor(status) {
            switch (status) {
                case "NEW / OPEN": return "bg-yellow-200 text-yellow-700";
                case "ANSWERED": return "bg-green-200 text-green-700";
                case "CLOSED": return "bg-gray-200 text-gray-700";
                default: return "bg-gray-200 text-gray-700";
            }
        }

        // Display issue details in response area
        function displayResponse(issueNumber) {
            let responseDiv = document.getElementById('response');
            const issue = issues.find(i => i.issue_number === issueNumber);

            if (issue) {
                responseDiv.innerHTML = `<div class="mb-4">
                        <p><span class="font-semibold">Issue Number:</span> ${issue.issue_number}</p>
                        <p><span class="font-semibold">Period:</span> ${issue.period}</p>
                        <p><span class="font-semibold">Company:</span> ${issue.company}</p>
                        <p><span class="font-semibold">Question:</span> ${issue.question}</p>
                        <p><span class="font-semibold">Question By (PIC):</span> ${issue.question_by}</p>
                        <p><span class="font-semibold">Question Attachment:</span> ${issue.attachment ? `<a href="${issue.attachment}" target="_blank" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-2 rounded focus:outline-none focus:shadow-outline inline-block ml-2 text-sm">Here</a>` : 'No attachment'}</p>
                    </div>
                    <div class="mb-4 border-t border-gray-200 pt-4">
                        <p><span class="font-semibold">Answer:</span> ${issue.answer ? issue.answer : 'Awaiting Answer'}</p>
                        <p><span class="font-semibold">Answer Attachment:</span> ${issue.answer_attachment ? `<a href="${issue.answer_attachment}" target="_blank" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-2 rounded focus:outline-none focus:shadow-outline inline-block ml-2 text-sm">Here</a>` : 'No attachment'}</p>
                    </div>
                    <div class="mb-4 border-t border-gray-200 pt-4">
                        <p><span class="font-semibold">Status:</span> <span class="${getStatusColor(issue.status)} py-1 px-3 rounded-full text-xs font-semibold">${issue.status}</span></p>
                    </div>`;
            } else {
                responseDiv.innerHTML = `<p>No issue found with issue number ${issueNumber}</p>`;
            }
        }
        
        // Export data to CSV
        function exportToCSV() {
            if (issues.length === 0) {
                alert('No data to export');
                return;
            }
            
            // Define CSV headers
            const headers = [
                'Issue #',
                'Period',
                'Company',
                'Question',
                'Question By (PIC)',
                'Attachment',
                'Status',
                'Answer',
                'Answer Attachment',
                'Date Created',
                'Date Updated'
            ];
            
            // Map issues to CSV rows
            const rows = issues.map(issue => [
                issue.issue_number,
                issue.period,
                issue.company,
                issue.question,
                issue.question_by,
                issue.attachment || '',
                issue.status,
                issue.answer || '',
                issue.answer_attachment || '',
                new Date(issue.created_at).toLocaleString(),
                issue.updated_at ? new Date(issue.updated_at).toLocaleString() : ''
            ]);
            
            // Combine headers and rows
            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
            ].join('\n');
            
            // Create a Blob and download link
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            
            // Set download attributes
            link.setAttribute('href', url);
            link.setAttribute('download', `tax_issues_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.display = 'none';
            
            // Append to body, trigger click, and clean up
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
